name: CoPas Dev Build + DMG + Tag

permissions:
  contents: write # WAJIB agar bisa push tag

on:
  push:
    branches:
      - dev

jobs:
  # =====================================================
  # BUILD macOS APP + DMG
  # =====================================================
  build:
    runs-on: macos-latest

    steps:
      # ------------------------
      # Checkout
      # ------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------
      # Build App
      # ------------------------
      - name: Build CoPas (Release)
        run: |
          xcodebuild \
            -project CoPas.xcodeproj \
            -scheme CoPas \
            -configuration Release \
            -derivedDataPath build \
            build

      # ------------------------
      # Install create-dmg
      # ------------------------
      - name: Install create-dmg
        run: brew install create-dmg

      # ------------------------
      # Build DMG
      # ------------------------
      - name: Create DMG
        run: |
          mkdir -p dist
          create-dmg \
            --volname "CoPas Dev" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "CoPas.app" 200 190 \
            --hide-extension "CoPas.app" \
            --app-drop-link 600 185 \
            dist/CoPas-dev.dmg \
            build/Build/Products/Release/CoPas.app

      # ------------------------
      # Upload Artifact
      # ------------------------
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: CoPas-dev-dmg
          path: dist/CoPas-dev.dmg

  # =====================================================
  # CREATE TAG (WIB) â€“ HANYA JIKA BUILD SUKSES
  # =====================================================
  create-tag:
    runs-on: ubuntu-latest
    needs: build
    env:
      TZ: Asia/Jakarta

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Hitung versi tag (WIB)
        id: ver
        run: |
          sudo ln -sf /usr/share/zoneinfo/$TZ /etc/localtime

          yy=$(date +%y)
          m=$(date +%-m)
          d=$(date +%-d)
          HH=$(date +%H)
          MM=$(date +%M)

          tag="v0.${yy}.${m}-${d}${HH}${MM}"

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Tag yang akan dibuat: $tag"

      - name: Cek apakah tag sudah ada
        id: check
        run: |
          git fetch --tags --quiet

          if git rev-parse -q --verify "refs/tags/${{ steps.ver.outputs.tag }}" >/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ Tag sudah ada"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Buat dan push tag
        if: steps.check.outputs.exists == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "${{ steps.ver.outputs.tag }}" -m "Auto dev tag ${{ steps.ver.outputs.tag }}"
          git push origin "${{ steps.ver.outputs.tag }}"
